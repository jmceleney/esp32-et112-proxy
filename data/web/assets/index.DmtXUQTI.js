import{l as $,d as h,E as D,k as O,y as F,A as U,D as N,L as k,G as W}from"./vendor.D-QKLAeK.js";(function(){const o=document.createElement("link").relList;if(o&&o.supports&&o.supports("modulepreload"))return;for(const s of document.querySelectorAll('link[rel="modulepreload"]'))d(s);new MutationObserver(s=>{for(const a of s)if(a.type==="childList")for(const c of a.addedNodes)c.tagName==="LINK"&&c.rel==="modulepreload"&&d(c)}).observe(document,{childList:!0,subtree:!0});function t(s){const a={};return s.integrity&&(a.integrity=s.integrity),s.referrerPolicy&&(a.referrerPolicy=s.referrerPolicy),s.crossOrigin==="use-credentials"?a.credentials="include":s.crossOrigin==="anonymous"?a.credentials="omit":a.credentials="same-origin",a}function d(s){if(s.ep)return;s.ep=!0;const a=t(s);fetch(s.href,a)}})();var _=0;function e(r,o,t,d,s,a){o||(o={});var c,m,p=o;if("ref"in p)for(m in p={},o)m=="ref"?c=o[m]:p[m]=o[m];var g={type:r,props:p,key:t,ref:c,__k:null,__:null,__b:0,__e:null,__c:null,constructor:void 0,__v:--_,__i:-1,__u:0,__source:s,__self:a};if(typeof r=="function"&&(c=r.defaultProps))for(m in c)p[m]===void 0&&(p[m]=c[m]);return $.vnode&&$.vnode(g),g}const M="";async function A(r,o={}){try{const t=await fetch(M+r,{headers:{"Content-Type":"application/json",...o.headers},...o});if(!t.ok)throw new Error(`HTTP ${t.status}: ${t.statusText}`);const d=t.headers.get("content-type");return d&&d.includes("application/json")?await t.json():await t.text()}catch(t){throw console.error(`API Error for ${r}:`,t),t}}async function T(r){return A(r)}async function R(r,o=null){const t={method:"POST"};return o&&(o instanceof FormData?(delete t.headers,t.body=o):t.body=JSON.stringify(o)),A(r,t)}const P={getStatus:()=>T("/status.json"),getLogs:(r=0,o=8192)=>T(`/logdata?position=${r}&chunk_size=${o}`),clearLogs:()=>R("/logclear"),getConfig:()=>T("/config"),updateConfig:r=>{const o=new FormData;return Object.entries(r).forEach(([t,d])=>{typeof d=="boolean"?d&&o.append(t,"on"):o.append(t,d)}),R("/config",o)},sendDebugCommand:(r,o,t,d)=>{const s=new FormData;return s.append("slave",r),s.append("reg",o),s.append("func",t),s.append("count",d),R("/debug",s)},reboot:()=>R("/reboot"),resetWifi:()=>R("/wifi"),uploadFirmware:(r,o)=>new Promise((t,d)=>{const s=new FormData;s.append("file",r);const a=new XMLHttpRequest;a.upload.addEventListener("progress",c=>{c.lengthComputable&&o&&o(Math.round(c.loaded/c.total*100))}),a.addEventListener("load",()=>{a.status>=200&&a.status<300?t(a.responseText):d(new Error(`Upload failed: ${a.status} ${a.statusText}`))}),a.addEventListener("error",()=>{d(new Error("Upload failed"))}),a.open("POST",M+"/update"),a.send(s)}),getMetrics:()=>T("/metrics")};function H({currentRoute:r}){const[o,t]=h(!1),[d,s]=h(!1),[a,c]=h(!1),[m,p]=h(null),g=async()=>{c(!0),p(null);try{await P.resetWifi(),t(!1),alert("WiFi settings reset! Device will restart and enter configuration mode.")}catch(n){p(n.message||"Failed to reset WiFi settings")}finally{c(!1)}},u=async()=>{c(!0),p(null);try{await P.reboot(),s(!1),alert("Device rebooting... Please wait 30 seconds before reconnecting.")}catch(n){p(n.message||"Failed to reboot device")}finally{c(!1)}},b=n=>r===n;return e(O,{children:[e("nav",{class:"navigation",children:e("div",{class:"nav-container",children:[e(D,{href:"/",class:"nav-brand",children:[e("div",{class:"nav-brand-icon",children:"E"}),e("span",{children:"ET112 Proxy"})]}),e("div",{class:"nav-menu",children:[e(D,{class:`nav-link ${b("/")?"active":""}`,href:"/",children:"üè† Home"}),e(D,{class:`nav-link ${b("/status")?"active":""}`,href:"/status",children:"üìä Status"}),e(D,{class:`nav-link ${b("/config")?"active":""}`,href:"/config",children:"‚öôÔ∏è Config"}),e(D,{class:`nav-link ${b("/debug")?"active":""}`,href:"/debug",children:"üîß Debug"}),e(D,{class:`nav-link ${b("/log")?"active":""}`,href:"/log",children:"üìù Logs"}),e(D,{class:`nav-link ${b("/update")?"active":""}`,href:"/update",children:"üì§ Update"})]}),e("div",{class:"nav-actions",children:[e("button",{class:"nav-link danger btn-link",onClick:()=>t(!0),disabled:a,title:"Reset WiFi Settings",children:"üì∂"}),e("button",{class:"nav-link danger btn-link",onClick:()=>s(!0),disabled:a,title:"Reboot Device",children:"üîÑ"})]})]})}),o&&e("div",{class:"modal-overlay",children:e("div",{class:"modal",children:[e("h3",{children:"‚ö†Ô∏è WiFi Reset Confirmation"}),e("p",{children:"This will reset all WiFi settings and restart the device in configuration mode."}),e("ul",{style:"margin: 1rem 0; padding-left: 1.5rem; line-height: 1.6;",children:[e("li",{children:"Current WiFi credentials will be erased"}),e("li",{children:"Device will restart and create an access point"}),e("li",{children:"You'll need to reconnect and reconfigure WiFi"}),e("li",{children:"This action cannot be undone"})]}),m&&e("div",{class:"error-message",style:"margin-bottom: 1rem; color: var(--danger-color);",children:["‚ùå ",m]}),e("div",{class:"modal-actions",children:[e("button",{class:"btn btn-danger",onClick:g,disabled:a,children:a?"‚è≥ Resetting...":"üîÑ Reset WiFi"}),e("button",{class:"btn btn-secondary",onClick:()=>t(!1),disabled:a,children:"Cancel"})]})]})}),d&&e("div",{class:"modal-overlay",children:e("div",{class:"modal",children:[e("h3",{children:"üîÑ Reboot Confirmation"}),e("p",{children:"This will restart the ESP32 device immediately."}),e("ul",{style:"margin: 1rem 0; padding-left: 1.5rem; line-height: 1.6;",children:[e("li",{children:"Device will restart and take ~30 seconds to boot"}),e("li",{children:"All current connections will be lost"}),e("li",{children:"Configuration and data will be preserved"}),e("li",{children:"You'll need to refresh this page after restart"})]}),m&&e("div",{class:"error-message",style:"margin-bottom: 1rem; color: var(--danger-color);",children:["‚ùå ",m]}),e("div",{class:"modal-actions",children:[e("button",{class:"btn btn-danger",onClick:u,disabled:a,children:a?"‚è≥ Rebooting...":"üîÑ Reboot Device"}),e("button",{class:"btn btn-secondary",onClick:()=>s(!1),disabled:a,children:"Cancel"})]})]})})]})}function G(){const[r,o]=h({voltage:null,current:null,power:null,frequency:null,uptime:null}),[t,d]=h(!0),[s,a]=h(null),[c,m]=h(null),p=async()=>{var n,i,l,f,C,x;try{const w=(await P.getStatus()).data||[],v={};w.forEach(S=>{S.name&&S.value&&(v[S.name]=S.value)}),o({voltage:parseFloat((n=v.Volts)==null?void 0:n.replace(" V",""))||null,current:parseFloat((i=v.Amps)==null?void 0:i.replace(" A",""))||null,power:parseFloat((l=v.Watts)==null?void 0:l.replace(" W",""))||null,frequency:parseFloat((f=v.Frequency)==null?void 0:f.replace(" Hz",""))||null,uptime:v["ESP Uptime"]||null,cpuCore0:parseFloat((C=v["ESP CPU Core 0 Load"])==null?void 0:C.replace("%",""))||null,cpuCore1:parseFloat((x=v["ESP CPU Core 1 Load"])==null?void 0:x.replace("%",""))||null}),a(null),m(new Date)}catch(y){console.error("Failed to fetch metrics:",y),a(y.message||"Failed to fetch metrics")}finally{d(!1)}};F(()=>{p();const n=setInterval(p,2e3);return()=>clearInterval(n)},[]);const g=(n,i,l=1)=>n==null?"---":`${n.toFixed(l)}${i}`,u=()=>t?"var(--warning-color)":s?"var(--danger-color)":r.power!==null?"var(--success-color)":"var(--text-muted)",b=()=>t?"Loading...":s?"Connection Error":r.power!==null?"Online":"No Data";return e("div",{children:[e("div",{class:"page-header",children:[e("h1",{class:"page-title",children:"ESP32 ET112 Energy Monitor"}),e("p",{class:"page-subtitle",children:"Real-time power monitoring from Carlo Gavazzi ET112 energy meter"})]}),e("div",{class:"card",children:e("div",{style:"display: flex; align-items: center; justify-content: space-between;",children:[e("div",{style:"display: flex; align-items: center; gap: 0.75rem;",children:[e("div",{style:`width: 12px; height: 12px; border-radius: 50%; background: ${u()};`}),e("span",{class:"font-semibold",children:b()})]}),c&&e("span",{class:"text-muted text-sm",children:["Last updated: ",c.toLocaleTimeString()]})]})}),s&&e("div",{class:"card",style:"background-color: var(--danger-color); color: white; margin-bottom: 1.5rem;",children:e("p",{style:"margin: 0;",children:["‚ùå ",s]})}),e("div",{class:"grid-3",children:[e("div",{class:"card metric-card",style:"background: linear-gradient(135deg, #10b981 0%, #059669 100%);",children:[e("div",{class:"card-title",children:"Voltage"}),e("div",{class:"metric-value",children:t?"---":g(r.voltage,"",1)}),e("div",{class:"metric-unit",children:"Volts"})]}),e("div",{class:"card metric-card",style:"background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);",children:[e("div",{class:"card-title",children:"Current"}),e("div",{class:"metric-value",children:t?"---":g(r.current,"",2)}),e("div",{class:"metric-unit",children:"Amperes"})]}),e("div",{class:"card metric-card",style:"background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%);",children:[e("div",{class:"card-title",children:"Active Power"}),e("div",{class:"metric-value",children:t?"---":g(r.power,"",0)}),e("div",{class:"metric-unit",children:"Watts"})]})]}),e("div",{class:"grid-4",children:[e("div",{class:"card",children:[e("div",{class:"card-title",children:"‚ö° Frequency"}),e("div",{style:"font-size: 1.5rem; font-weight: 600; color: var(--primary-color);",children:t?"---":g(r.frequency," Hz",2)})]}),e("div",{class:"card",children:[e("div",{class:"card-title",children:"üñ•Ô∏è CPU Core 0"}),e("div",{style:"font-size: 1.5rem; font-weight: 600; color: var(--secondary-color);",children:t?"---":g(r.cpuCore0,"%",1)})]}),e("div",{class:"card",children:[e("div",{class:"card-title",children:"üñ•Ô∏è CPU Core 1"}),e("div",{style:"font-size: 1.5rem; font-weight: 600; color: var(--secondary-color);",children:t?"---":g(r.cpuCore1,"%",1)})]}),e("div",{class:"card",children:[e("div",{class:"card-title",children:"‚è±Ô∏è System Uptime"}),e("div",{style:"font-size: 1.5rem; font-weight: 600; color: var(--primary-color);",children:t?"---":r.uptime||"Unknown"})]})]}),e("div",{class:"card",children:[e("div",{class:"card-title",children:"‚ö° Quick Actions"}),e("div",{style:"display: flex; gap: 1rem; flex-wrap: wrap;",children:[e("a",{href:"/status",class:"btn btn-primary",children:"üìä View Detailed Status"}),e("a",{href:"/config",class:"btn btn-secondary",children:"‚öôÔ∏è Configuration"}),e("a",{href:"/debug",class:"btn btn-secondary",children:"üîß Debug Tools"})]})]}),e("div",{class:"grid-2",children:[e("div",{class:"card",children:[e("div",{class:"card-title",children:"üì° About This Device"}),e("div",{class:"text-sm",style:"line-height: 1.6;",children:[e("p",{children:"This ESP32 device acts as a Modbus RTU/TCP gateway for the Carlo Gavazzi ET112 energy meter, providing real-time power monitoring data."}),e("ul",{style:"margin: 0.5rem 0; padding-left: 1.5rem;",children:[e("li",{children:"Real-time energy monitoring"}),e("li",{children:"Modbus RTU client ‚Üí TCP server"}),e("li",{children:"Compatible with Victron GX devices"}),e("li",{children:"Web-based configuration"})]})]})]}),e("div",{class:"card",children:[e("div",{class:"card-title",children:"üîó Quick Links"}),e("div",{class:"text-sm",children:e("div",{style:"display: flex; flex-direction: column; gap: 0.5rem;",children:[e("a",{href:"/log",style:"color: var(--primary-color); text-decoration: none;",children:"üìù View System Logs"}),e("a",{href:"/update",style:"color: var(--primary-color); text-decoration: none;",children:"üì§ Update Firmware"}),e("a",{href:"/debug",style:"color: var(--primary-color); text-decoration: none;",children:"üîß Test Modbus Communication"}),e("a",{href:"/metrics",style:"color: var(--primary-color); text-decoration: none;",children:"üìà Prometheus Metrics"})]})})]})]})]})}function j(){const[r,o]=h(null),[t,d]=h(!0),[s,a]=h(null),c=async()=>{try{const u=await fetch("/status.json");if(!u.ok)throw new Error(`HTTP error! status: ${u.status}`);const b=await u.json();o(b),a(null)}catch(u){console.error("Failed to fetch status data:",u),a(u.message)}finally{d(!1)}};F(()=>{c();const u=setInterval(c,5e3);return()=>clearInterval(u)},[]);const m=u=>{if(typeof u=="string"){if(u.toLowerCase().includes("yes")||u.toLowerCase().includes("connected"))return"status-ok";if(u.toLowerCase().includes("no")||u.toLowerCase().includes("not connected"))return"status-error"}return""},p=(u,b)=>{const n=u.filter(i=>i.low!==void 0&&i.high!==void 0&&i.low!==""&&i.high!=="");return n.length===0?null:e("div",{class:"card",children:[e("h3",{class:"card-title",children:b}),e("div",{class:"table-responsive",children:e("table",{class:"table",children:[e("thead",{children:e("tr",{children:[e("th",{children:"Name"}),e("th",{children:"Current"}),e("th",{children:"Low"}),e("th",{children:"High"})]})}),e("tbody",{children:n.map((i,l)=>e("tr",{children:[e("td",{children:i.name}),e("td",{children:i.value}),e("td",{children:i.low}),e("td",{children:i.high})]},l))})]})})]})},g=(u,b)=>{const n=u.filter(i=>i.low===void 0||i.high===void 0||i.low===""||i.high==="");return n.length===0?null:e("div",{class:"card",children:[e("h3",{class:"card-title",children:b}),e("div",{class:"table-responsive",children:e("table",{class:"table",children:e("tbody",{children:n.map((i,l)=>e("tr",{children:[e("td",{style:"font-weight: 500;",children:i.name}),e("td",{class:m(i.value),children:i.value})]},l))})})})]})};return t?e("div",{class:"loading",children:"Loading status data..."}):s?e("div",{class:"card",children:[e("h2",{class:"card-title",children:"Error Loading Status"}),e("p",{class:"status-error",children:["Failed to load status data: ",s]}),e("button",{class:"btn btn-primary",onClick:c,children:"Retry"})]}):!r||!r.data?e("div",{class:"card",children:[e("h2",{class:"card-title",children:"No Status Data"}),e("p",{children:"No status data available."})]}):e("div",{children:[e("h1",{style:"margin-bottom: 2rem;",children:"System Status"}),e("div",{style:"display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 2rem;",children:[g(r.data,"System Information"),p(r.data,"Energy Metrics")]}),e("div",{class:"card",children:[e("div",{style:"display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;",children:[e("h3",{class:"card-title",style:"margin: 0;",children:"Raw Status Data"}),e("button",{class:"btn btn-primary",onClick:c,children:"üîÑ Refresh"})]}),e("pre",{style:"background: #f8f9fa; padding: 1rem; border-radius: 4px; overflow-x: auto; font-size: 0.875rem;",children:JSON.stringify(r,null,2)})]})]})}function V(){const[r,o]=h({hostname:"",pi:1e3,clientIsRTU:!0,mb:9600,md:8,mp:0,ms:1,mr:-1,sip:"",tp2:502,mb2:9600,md2:8,mp2:0,ms2:1,mr2:-1,tp3:502,sb:115200,sd:8,sp:0,ss:1,useStaticIP:!1,staticIP:"",staticGateway:"",staticSubnet:""}),[t,d]=h(!1),[s,a]=h(null),[c,m]=h(!1),[p,g]=h({});F(()=>{},[]);const u=()=>{const l={};if(r.hostname.trim()||(l.hostname="Hostname is required"),r.pi<100&&(l.pi="Polling interval must be at least 100ms"),r.useStaticIP){const f=/^(?:[0-9]{1,3}\.){3}[0-9]{1,3}$/;(!r.staticIP||!f.test(r.staticIP))&&(l.staticIP="Invalid IP address"),(!r.staticGateway||!f.test(r.staticGateway))&&(l.staticGateway="Invalid gateway IP"),(!r.staticSubnet||!f.test(r.staticSubnet))&&(l.staticSubnet="Invalid subnet mask")}if(!r.clientIsRTU){const f=/^(?:[0-9]{1,3}\.){3}[0-9]{1,3}$/;(!r.sip||!f.test(r.sip))&&(l.sip="Invalid server IP address")}return g(l),Object.keys(l).length===0},b=async l=>{if(l.preventDefault(),!!u()){d(!0),a(null);try{await P.updateConfig(r),m(!0),setTimeout(()=>m(!1),3e3)}catch(f){a(f.message||"Failed to update configuration")}finally{d(!1)}}},n=(l,f)=>{o(C=>({...C,[l]:f})),p[l]&&g(C=>({...C,[l]:null}))},i=l=>p[l]?e("div",{style:"color: var(--danger-color); font-size: 0.875rem; margin-top: 0.25rem;",children:p[l]}):null;return e("div",{children:[e("h1",{style:"margin-bottom: 2rem;",children:"Configuration"}),s&&e("div",{class:"card",style:"background-color: var(--danger-color); color: white; margin-bottom: 1rem;",children:e("p",{style:"margin: 0;",children:["‚ùå ",s]})}),c&&e("div",{class:"card",style:"background-color: var(--success-color); color: white; margin-bottom: 1rem;",children:e("p",{style:"margin: 0;",children:"‚úÖ Configuration updated successfully!"})}),e("form",{onSubmit:b,children:[e("div",{class:"card",children:[e("h3",{class:"card-title",children:"General Settings"}),e("div",{class:"form-group",children:[e("label",{class:"form-label",for:"hostname",children:"Hostname"}),e("input",{type:"text",id:"hostname",class:"form-control",value:r.hostname,onInput:l=>n("hostname",l.target.value),placeholder:"esp32-proxy"}),i("hostname")]}),e("div",{class:"form-group",children:[e("label",{class:"form-label",for:"pi",children:"Polling Interval (ms)"}),e("input",{type:"number",id:"pi",class:"form-control",min:"100",value:r.pi,onInput:l=>n("pi",parseInt(l.target.value))}),i("pi")]}),e("div",{class:"form-group",children:e("div",{class:"form-check",children:[e("input",{type:"checkbox",id:"clientIsRTU",class:"form-check-input",checked:r.clientIsRTU,onChange:l=>n("clientIsRTU",l.target.checked)}),e("label",{class:"form-label",for:"clientIsRTU",children:"Modbus Client is RTU"})]})})]}),r.clientIsRTU&&e("div",{class:"card",children:[e("h3",{class:"card-title",children:"Modbus RTU Client"}),e("div",{style:"display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;",children:[e("div",{class:"form-group",children:[e("label",{class:"form-label",for:"mb",children:"Baud Rate"}),e("input",{type:"number",id:"mb",class:"form-control",value:r.mb,onInput:l=>n("mb",parseInt(l.target.value))})]}),e("div",{class:"form-group",children:[e("label",{class:"form-label",for:"md",children:"Data Bits"}),e("input",{type:"number",id:"md",class:"form-control",min:"5",max:"8",value:r.md,onInput:l=>n("md",parseInt(l.target.value))})]})]}),e("div",{style:"display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;",children:[e("div",{class:"form-group",children:[e("label",{class:"form-label",for:"mp",children:"Parity"}),e("select",{id:"mp",class:"form-control",value:r.mp,onChange:l=>n("mp",parseInt(l.target.value)),children:[e("option",{value:0,children:"None"}),e("option",{value:2,children:"Even"}),e("option",{value:3,children:"Odd"})]})]}),e("div",{class:"form-group",children:[e("label",{class:"form-label",for:"ms",children:"Stop Bits"}),e("select",{id:"ms",class:"form-control",value:r.ms,onChange:l=>n("ms",parseInt(l.target.value)),children:[e("option",{value:1,children:"1 bit"}),e("option",{value:2,children:"1.5 bits"}),e("option",{value:3,children:"2 bits"})]})]})]}),e("div",{class:"form-group",children:[e("label",{class:"form-label",for:"mr",children:"RTS Pin"}),e("select",{id:"mr",class:"form-control",value:r.mr,onChange:l=>n("mr",parseInt(l.target.value)),children:[e("option",{value:-1,children:"Auto"}),e("option",{value:4,children:"D4"}),e("option",{value:13,children:"D13"}),e("option",{value:14,children:"D14"}),e("option",{value:18,children:"D18"}),e("option",{value:19,children:"D19"}),e("option",{value:21,children:"D21"}),e("option",{value:22,children:"D22"}),e("option",{value:23,children:"D23"}),e("option",{value:25,children:"D25"}),e("option",{value:26,children:"D26"}),e("option",{value:27,children:"D27"}),e("option",{value:32,children:"D32"}),e("option",{value:33,children:"D33"})]})]})]}),!r.clientIsRTU&&e("div",{class:"card",children:[e("h3",{class:"card-title",children:"Modbus TCP Client Settings"}),e("div",{style:"display: grid; grid-template-columns: 2fr 1fr; gap: 1rem;",children:[e("div",{class:"form-group",children:[e("label",{class:"form-label",for:"sip",children:"Server IP Address"}),e("input",{type:"text",id:"sip",class:"form-control",value:r.sip,onInput:l=>n("sip",l.target.value),placeholder:"192.168.1.100"}),i("sip")]}),e("div",{class:"form-group",children:[e("label",{class:"form-label",for:"tp2",children:"Server Port"}),e("input",{type:"number",id:"tp2",class:"form-control",min:"1",max:"65535",value:r.tp2,onInput:l=>n("tp2",parseInt(l.target.value))})]})]})]}),e("div",{class:"card",children:[e("h3",{class:"card-title",children:"Modbus Secondary RTU (Server/Slave)"}),e("div",{style:"display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;",children:[e("div",{class:"form-group",children:[e("label",{class:"form-label",for:"mb2",children:"Baud Rate"}),e("input",{type:"number",id:"mb2",class:"form-control",value:r.mb2,onInput:l=>n("mb2",parseInt(l.target.value))})]}),e("div",{class:"form-group",children:[e("label",{class:"form-label",for:"md2",children:"Data Bits"}),e("input",{type:"number",id:"md2",class:"form-control",min:"5",max:"8",value:r.md2,onInput:l=>n("md2",parseInt(l.target.value))})]})]}),e("div",{style:"display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;",children:[e("div",{class:"form-group",children:[e("label",{class:"form-label",for:"mp2",children:"Parity"}),e("select",{id:"mp2",class:"form-control",value:r.mp2,onChange:l=>n("mp2",parseInt(l.target.value)),children:[e("option",{value:0,children:"None"}),e("option",{value:2,children:"Even"}),e("option",{value:3,children:"Odd"})]})]}),e("div",{class:"form-group",children:[e("label",{class:"form-label",for:"ms2",children:"Stop Bits"}),e("select",{id:"ms2",class:"form-control",value:r.ms2,onChange:l=>n("ms2",parseInt(l.target.value)),children:[e("option",{value:1,children:"1 bit"}),e("option",{value:2,children:"1.5 bits"}),e("option",{value:3,children:"2 bits"})]})]})]}),e("div",{class:"form-group",children:[e("label",{class:"form-label",for:"mr2",children:"RTS Pin"}),e("select",{id:"mr2",class:"form-control",value:r.mr2,onChange:l=>n("mr2",parseInt(l.target.value)),children:[e("option",{value:-1,children:"Auto"}),e("option",{value:4,children:"D4"}),e("option",{value:13,children:"D13"}),e("option",{value:14,children:"D14"}),e("option",{value:18,children:"D18"}),e("option",{value:19,children:"D19"}),e("option",{value:21,children:"D21"}),e("option",{value:22,children:"D22"}),e("option",{value:23,children:"D23"}),e("option",{value:25,children:"D25"}),e("option",{value:26,children:"D26"}),e("option",{value:27,children:"D27"}),e("option",{value:32,children:"D32"}),e("option",{value:33,children:"D33"})]})]})]}),e("div",{class:"card",children:[e("h3",{class:"card-title",children:"Modbus Secondary TCP Server"}),e("div",{class:"form-group",children:[e("label",{class:"form-label",for:"tp3",children:"Port Number"}),e("input",{type:"number",id:"tp3",class:"form-control",min:"1",max:"65535",value:r.tp3,onInput:l=>n("tp3",parseInt(l.target.value))})]})]}),e("div",{class:"card",children:[e("h3",{class:"card-title",children:"Serial (Debug)"}),e("div",{style:"display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;",children:[e("div",{class:"form-group",children:[e("label",{class:"form-label",for:"sb",children:"Baud Rate"}),e("input",{type:"number",id:"sb",class:"form-control",value:r.sb,onInput:l=>n("sb",parseInt(l.target.value))})]}),e("div",{class:"form-group",children:[e("label",{class:"form-label",for:"sd",children:"Data Bits"}),e("input",{type:"number",id:"sd",class:"form-control",min:"5",max:"8",value:r.sd,onInput:l=>n("sd",parseInt(l.target.value))})]})]}),e("div",{style:"display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;",children:[e("div",{class:"form-group",children:[e("label",{class:"form-label",for:"sp",children:"Parity"}),e("select",{id:"sp",class:"form-control",value:r.sp,onChange:l=>n("sp",parseInt(l.target.value)),children:[e("option",{value:0,children:"None"}),e("option",{value:2,children:"Even"}),e("option",{value:3,children:"Odd"})]})]}),e("div",{class:"form-group",children:[e("label",{class:"form-label",for:"ss",children:"Stop Bits"}),e("select",{id:"ss",class:"form-control",value:r.ss,onChange:l=>n("ss",parseInt(l.target.value)),children:[e("option",{value:1,children:"1 bit"}),e("option",{value:2,children:"1.5 bits"}),e("option",{value:3,children:"2 bits"})]})]})]})]}),e("div",{class:"card",children:[e("h3",{class:"card-title",children:"Network Settings"}),e("div",{class:"form-group",children:e("div",{class:"form-check",children:[e("input",{type:"checkbox",id:"useStaticIP",class:"form-check-input",checked:r.useStaticIP,onChange:l=>n("useStaticIP",l.target.checked)}),e("label",{class:"form-label",for:"useStaticIP",children:"Use Static IP"})]})}),r.useStaticIP&&e("div",{children:[e("div",{class:"form-group",children:[e("label",{class:"form-label",for:"staticIP",children:"Static IP Address"}),e("input",{type:"text",id:"staticIP",class:"form-control",value:r.staticIP,onInput:l=>n("staticIP",l.target.value),placeholder:"192.168.1.100"}),i("staticIP")]}),e("div",{style:"display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;",children:[e("div",{class:"form-group",children:[e("label",{class:"form-label",for:"staticGateway",children:"Gateway IP"}),e("input",{type:"text",id:"staticGateway",class:"form-control",value:r.staticGateway,onInput:l=>n("staticGateway",l.target.value),placeholder:"192.168.1.1"}),i("staticGateway")]}),e("div",{class:"form-group",children:[e("label",{class:"form-label",for:"staticSubnet",children:"Subnet Mask"}),e("input",{type:"text",id:"staticSubnet",class:"form-control",value:r.staticSubnet,onInput:l=>n("staticSubnet",l.target.value),placeholder:"255.255.255.0"}),i("staticSubnet")]})]})]})]}),e("div",{style:"display: flex; gap: 1rem; margin-top: 2rem;",children:e("button",{type:"submit",class:"btn btn-primary",disabled:t,style:"flex: 1;",children:t?"‚è≥ Saving...":"üíæ Save Configuration"})})]})]})}const q={1:"Read Coils",2:"Read Discrete Inputs",3:"Read Holding Registers",4:"Read Input Registers"};function Q(){const[r,o]=h({slave:1,reg:1,func:3,count:1}),[t,d]=h(null),[s,a]=h(!1),[c,m]=h(null),[p,g]=h([]),u=(i,l)=>{o(f=>({...f,[i]:parseInt(l)}))},b=async i=>{i.preventDefault(),a(!0),m(null),d(null);const l=Date.now();try{const f=await P.sendDebugCommand(r.slave,r.reg,r.func,r.count),x=Date.now()-l,y={timestamp:new Date().toLocaleTimeString(),command:`Slave ${r.slave}, Function ${r.func}, Register ${r.reg}, Count ${r.count}`,duration:`${x}ms`,response:f,success:!f.includes("Error:")};d(y),g(w=>[y,...w.slice(0,9)])}catch(f){const C={timestamp:new Date().toLocaleTimeString(),command:`Slave ${r.slave}, Function ${r.func}, Register ${r.reg}, Count ${r.count}`,duration:`${Date.now()-l}ms`,response:f.message,success:!1,error:!0};d(C),m(f.message||"Debug command failed")}finally{a(!1)}},n=()=>{g([]),d(null),m(null)};return e("div",{children:[e("h1",{style:"margin-bottom: 2rem;",children:"Modbus Debug Tools"}),c&&e("div",{class:"card",style:"background-color: var(--danger-color); color: white; margin-bottom: 1rem;",children:e("p",{style:"margin: 0;",children:["‚ùå ",c]})}),e("div",{class:"card",children:[e("h3",{class:"card-title",children:"Send Modbus Command"}),e("form",{onSubmit:b,children:[e("div",{style:"display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1rem;",children:[e("div",{class:"form-group",children:[e("label",{class:"form-label",for:"slave",children:"Slave ID"}),e("input",{type:"number",id:"slave",class:"form-control",min:"0",max:"247",value:r.slave,onInput:i=>u("slave",i.target.value)})]}),e("div",{class:"form-group",children:[e("label",{class:"form-label",for:"func",children:"Function Code"}),e("select",{id:"func",class:"form-control",value:r.func,onChange:i=>u("func",i.target.value),children:Object.entries(q).map(([i,l])=>e("option",{value:i,children:[i," - ",l]},i))})]})]}),e("div",{style:"display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1rem;",children:[e("div",{class:"form-group",children:[e("label",{class:"form-label",for:"reg",children:"Register Address"}),e("input",{type:"number",id:"reg",class:"form-control",min:"0",max:"65535",value:r.reg,onInput:i=>u("reg",i.target.value)})]}),e("div",{class:"form-group",children:[e("label",{class:"form-label",for:"count",children:"Count"}),e("input",{type:"number",id:"count",class:"form-control",min:"1",max:"125",value:r.count,onInput:i=>u("count",i.target.value)})]})]}),e("div",{style:"display: flex; gap: 1rem;",children:[e("button",{type:"submit",class:"btn btn-primary",disabled:s,style:"flex: 1;",children:s?"‚è≥ Sending...":"üîß Send Command"}),e("button",{type:"button",class:"btn btn-danger",onClick:n,children:"üóëÔ∏è Clear History"})]})]})]}),t&&e("div",{class:"card",children:[e("h3",{class:"card-title",children:t.success?"‚úÖ Command Result":"‚ùå Command Failed"}),e("div",{style:"background-color: var(--light-color); padding: 1rem; border-radius: 4px; margin-bottom: 1rem;",children:e("div",{style:"display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; font-size: 0.875rem;",children:[e("div",{children:[e("strong",{children:"Command:"})," ",t.command]}),e("div",{children:[e("strong",{children:"Time:"})," ",t.timestamp]}),e("div",{children:[e("strong",{children:"Duration:"})," ",t.duration]}),e("div",{children:[e("strong",{children:"Status:"}),e("span",{style:`color: ${t.success?"var(--success-color)":"var(--danger-color)"};`,children:t.success?"Success":"Failed"})]})]})}),e("div",{style:"background-color: #1e1e1e; color: #ffffff; padding: 1rem; border-radius: 4px; font-family: monospace; font-size: 0.875rem; white-space: pre-wrap; overflow-x: auto;",children:t.response})]}),p.length>0&&e("div",{class:"card",children:[e("h3",{class:"card-title",children:"Command History"}),e("div",{style:"max-height: 400px; overflow-y: auto;",children:p.map((i,l)=>e("div",{style:"border-bottom: 1px solid var(--border-color); padding: 1rem 0; margin-bottom: 1rem;",children:[e("div",{style:"display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;",children:[e("div",{style:"font-size: 0.875rem; color: var(--text-muted);",children:[i.timestamp," ‚Ä¢ ",i.duration]}),e("div",{style:`font-size: 0.875rem; font-weight: bold; color: ${i.success?"var(--success-color)":"var(--danger-color)"};`,children:i.success?"‚úÖ Success":"‚ùå Failed"})]}),e("div",{style:"font-size: 0.875rem; margin-bottom: 0.5rem;",children:[e("strong",{children:"Command:"})," ",i.command]}),e("div",{style:"background-color: #f8f9fa; padding: 0.75rem; border-radius: 4px; font-family: monospace; font-size: 0.8125rem; max-height: 150px; overflow-y: auto;",children:i.response})]},l))})]}),e("div",{class:"card",children:[e("h3",{class:"card-title",children:"üìö Modbus Quick Reference"}),e("div",{style:"display: grid; grid-template-columns: 1fr 1fr; gap: 2rem;",children:[e("div",{children:[e("h4",{children:"Function Codes:"}),e("ul",{style:"font-size: 0.875rem; line-height: 1.6;",children:[e("li",{children:[e("strong",{children:"01:"})," Read Coils (0x references)"]}),e("li",{children:[e("strong",{children:"02:"})," Read Discrete Inputs (1x references)"]}),e("li",{children:[e("strong",{children:"03:"})," Read Holding Registers (4x references)"]}),e("li",{children:[e("strong",{children:"04:"})," Read Input Registers (3x references)"]})]})]}),e("div",{children:[e("h4",{children:"ET112 Common Registers:"}),e("ul",{style:"font-size: 0.875rem; line-height: 1.6;",children:[e("li",{children:[e("strong",{children:"0:"})," Voltage L1-N"]}),e("li",{children:[e("strong",{children:"6:"})," Current L1"]}),e("li",{children:[e("strong",{children:"12:"})," Power L1"]}),e("li",{children:[e("strong",{children:"46:"})," Frequency"]}),e("li",{children:[e("strong",{children:"72:"})," Total Active Energy Import"]})]})]})]}),e("div",{style:"margin-top: 1rem; padding: 1rem; background-color: var(--light-color); border-radius: 4px; font-size: 0.875rem;",children:[e("h4",{style:"margin-top: 0;",children:"üí° Tips:"}),e("ul",{style:"margin: 0; padding-left: 1.5rem;",children:[e("li",{children:"Use Function 3 (Read Holding Registers) for most ET112 data"}),e("li",{children:"Start with Slave ID 1 and Register 0, Count 1 for basic testing"}),e("li",{children:"Check the logs for detailed Modbus communication traces"}),e("li",{children:"Values are returned as raw hex - interpretation depends on register type"})]})]})]})]})}function J(){const[r,o]=h(""),[t,d]=h(!0),[s,a]=h(null),[c,m]=h(!0),[p,g]=h(0),[u,b]=h(!1),[n,i]=h(!1),l=U(),f=U(),C=async(v=!1)=>{try{const I=(await P.getLogs(v?0:p)).split(`
`);if(I.length>=3){const z=parseInt(I[0]),E=I[1]==="1",L=I.slice(2).join(`
`);g(z),b(E),v?o(L):L.trim()&&o(B=>B+L)}a(null)}catch(S){console.error("Failed to fetch logs:",S),a(S.message||"Failed to fetch logs")}finally{d(!1)}},x=async()=>{try{await P.clearLogs(),o(""),g(0),a(null)}catch(v){a(v.message||"Failed to clear logs")}},y=()=>{i(v=>!v)};F(()=>{if(c&&l.current&&!n){const v=l.current;v.scrollTop=v.scrollHeight}},[r,c,n]),F(()=>(C(!0),f.current=setInterval(()=>{n||C(!1)},2e3),()=>{f.current&&clearInterval(f.current)}),[n,p]);const w=v=>{const S=v.target,I=Math.abs(S.scrollHeight-S.scrollTop-S.clientHeight)<10;m(I)};return t?e("div",{class:"loading",children:"Loading logs..."}):e("div",{children:[e("div",{style:"display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;",children:[e("h1",{style:"margin: 0;",children:"System Logs"}),e("div",{style:"display: flex; gap: 0.5rem; align-items: center;",children:[e("button",{class:`btn ${n?"btn-success":"btn-primary"}`,onClick:y,style:"padding: 0.5rem 1rem; font-size: 0.875rem;",children:n?"‚ñ∂Ô∏è Resume":"‚è∏Ô∏è Pause"}),e("button",{class:"btn btn-danger",onClick:x,style:"padding: 0.5rem 1rem; font-size: 0.875rem;",children:"üóëÔ∏è Clear"}),e("button",{class:"btn btn-primary",onClick:()=>C(!0),style:"padding: 0.5rem 1rem; font-size: 0.875rem;",children:"üîÑ Refresh"})]})]}),e("div",{style:"display: flex; gap: 1rem; margin-bottom: 1rem; font-size: 0.875rem;",children:[e("div",{style:`color: ${n?"var(--warning-color)":"var(--success-color)"};`,children:n?"‚è∏Ô∏è Paused":"üîÑ Live"}),u&&e("div",{style:"color: var(--warning-color);",children:"‚ö†Ô∏è Buffer overflow - some logs may be missing"}),e("div",{style:"color: var(--text-muted);",children:["Position: ",p]}),e("div",{style:`color: ${c?"var(--success-color)":"var(--text-muted)"};`,children:c?"üìÑ Auto-scroll ON":"üìÑ Auto-scroll OFF"})]}),s&&e("div",{class:"card",style:"background-color: var(--danger-color); color: white; margin-bottom: 1rem;",children:e("p",{style:"margin: 0;",children:["‚ùå ",s]})}),e("div",{class:"card",style:"padding: 0; overflow: hidden;",children:e("div",{ref:l,onScroll:w,style:{height:"600px",overflow:"auto",padding:"1rem",backgroundColor:"#1e1e1e",color:"#ffffff",fontFamily:'Monaco, "Cascadia Code", "Roboto Mono", Consolas, "Courier New", monospace',fontSize:"0.875rem",lineHeight:"1.4",whiteSpace:"pre-wrap",wordBreak:"break-word"},children:r||"No logs available. Waiting for log data..."})}),e("div",{style:"margin-top: 1rem; padding: 1rem; background-color: var(--light-color); border-radius: 4px; font-size: 0.875rem; color: var(--text-muted);",children:[e("h4",{style:"margin-top: 0;",children:"üí° Tips:"}),e("ul",{style:"margin: 0; padding-left: 1.5rem;",children:[e("li",{children:[e("strong",{children:"Auto-scroll:"})," Scroll to bottom to enable auto-scroll for new logs"]}),e("li",{children:[e("strong",{children:"Pause:"})," Use pause to stop fetching new logs while investigating"]}),e("li",{children:[e("strong",{children:"Clear:"})," Clear logs to reduce memory usage and start fresh"]}),e("li",{children:[e("strong",{children:"Live updates:"})," Logs refresh automatically every 2 seconds when not paused"]})]})]})]})}function K(){const[r,o]=h(null),[t,d]=h(!1),[s,a]=h(0),[c,m]=h(null),[p,g]=h(!1),[u,b]=h(null),n=U(),i=y=>{const w=y.target.files[0];w&&(o(w),m(null),g(!1),b(null))},l=y=>{if(!y)return"Please select a file to upload";const w=[".bin",".hex",".elf"],v=y.name.toLowerCase();if(!w.some(E=>v.endsWith(E)))return`Invalid file type. Please select a firmware file (${w.join(", ")})`;const I=10*1024*1024;return y.size>I?"File too large. Maximum size is 10MB":y.size<1024?"File too small. Are you sure this is a valid firmware file?":null},f=async()=>{const y=l(r);if(y){m(y);return}d(!0),m(null),a(0);try{const w=await P.uploadFirmware(r,v=>{a(v)});g(!0),b({message:"Firmware uploaded successfully! The device will restart automatically.",details:w}),o(null),n.current&&(n.current.value="")}catch(w){m(w.message||"Upload failed"),a(0)}finally{d(!1)}},C=()=>{o(null),m(null),g(!1),a(0),b(null),n.current&&(n.current.value="")},x=y=>{if(y===0)return"0 Bytes";const w=1024,v=["Bytes","KB","MB","GB"],S=Math.floor(Math.log(y)/Math.log(w));return parseFloat((y/Math.pow(w,S)).toFixed(2))+" "+v[S]};return e("div",{children:[e("h1",{style:"margin-bottom: 2rem;",children:"Firmware Update"}),e("div",{class:"card",style:"background-color: #fff3cd; border: 1px solid #ffeaa7; color: #856404; margin-bottom: 2rem;",children:[e("h3",{style:"margin-top: 0; color: #856404;",children:"‚ö†Ô∏è Important Warning"}),e("ul",{style:"margin: 0; padding-left: 1.5rem; line-height: 1.6;",children:[e("li",{children:[e("strong",{children:"Do not disconnect power"})," during the update process"]}),e("li",{children:[e("strong",{children:"Do not close this page"})," until the update completes"]}),e("li",{children:["The device will ",e("strong",{children:"restart automatically"})," after successful update"]}),e("li",{children:["Only upload ",e("strong",{children:"valid ESP32 firmware files"})," (.bin, .hex, .elf)"]}),e("li",{children:["Uploading incorrect firmware may ",e("strong",{children:"brick your device"})]})]})]}),c&&e("div",{class:"card",style:"background-color: var(--danger-color); color: white; margin-bottom: 1rem;",children:e("p",{style:"margin: 0;",children:["‚ùå ",c]})}),p&&u&&e("div",{class:"card",style:"background-color: var(--success-color); color: white; margin-bottom: 1rem;",children:[e("h3",{style:"margin-top: 0;",children:"‚úÖ Update Successful!"}),e("p",{style:"margin: 0;",children:u.message}),u.details&&e("div",{style:"margin-top: 1rem; padding: 1rem; background-color: rgba(255,255,255,0.1); border-radius: 4px; font-family: monospace; font-size: 0.875rem; white-space: pre-wrap;",children:u.details})]}),e("div",{class:"card",children:[e("h3",{class:"card-title",children:"Select Firmware File"}),e("div",{class:"form-group",children:[e("label",{class:"form-label",children:"Choose Firmware File"}),e("input",{ref:n,type:"file",class:"form-control",accept:".bin,.hex,.elf",onChange:i,disabled:t}),e("div",{style:"font-size: 0.875rem; color: var(--text-muted); margin-top: 0.5rem;",children:"Supported formats: .bin, .hex, .elf ‚Ä¢ Maximum size: 10MB"})]}),r&&e("div",{style:"background-color: var(--light-color); padding: 1rem; border-radius: 4px; margin-top: 1rem;",children:[e("h4",{style:"margin-top: 0;",children:"Selected File:"}),e("div",{style:"display: grid; grid-template-columns: auto 1fr auto; gap: 1rem; align-items: center;",children:[e("div",{children:"üìÑ"}),e("div",{children:[e("div",{style:"font-weight: 500;",children:r.name}),e("div",{style:"font-size: 0.875rem; color: var(--text-muted);",children:[x(r.size)," ‚Ä¢ ",r.type||"Binary file"]})]}),e("button",{class:"btn btn-danger",onClick:C,disabled:t,style:"padding: 0.5rem; font-size: 0.875rem;",children:"‚úï"})]})]})]}),t&&e("div",{class:"card",children:[e("h3",{class:"card-title",children:"üîÑ Uploading Firmware"}),e("div",{style:"margin-bottom: 1rem;",children:[e("div",{style:"display: flex; justify-content: space-between; margin-bottom: 0.5rem;",children:[e("span",{children:"Upload Progress"}),e("span",{children:[s,"%"]})]}),e("div",{style:"width: 100%; background-color: #e0e0e0; border-radius: 4px; height: 20px; overflow: hidden;",children:e("div",{style:{width:`${s}%`,height:"100%",backgroundColor:"var(--primary-color)",transition:"width 0.3s ease-in-out"}})})]}),e("div",{style:"font-size: 0.875rem; color: var(--text-muted); text-align: center;",children:s===0?"Preparing upload...":s<100?"Uploading firmware...":"Processing firmware..."})]}),e("div",{style:"display: flex; gap: 1rem; margin-top: 2rem;",children:[e("button",{class:"btn btn-primary",onClick:f,disabled:!r||t,style:"flex: 1;",children:t?"‚è≥ Uploading...":"üì§ Start Upload"}),e("button",{class:"btn btn-danger",onClick:C,disabled:t,children:"üóëÔ∏è Clear"})]}),e("div",{class:"card",style:"margin-top: 2rem;",children:[e("h3",{class:"card-title",children:"üìã Update Process"}),e("div",{style:"display: grid; grid-template-columns: 1fr 1fr; gap: 2rem;",children:[e("div",{children:[e("h4",{children:"Before Updating:"}),e("ol",{style:"font-size: 0.875rem; line-height: 1.6;",children:[e("li",{children:"Ensure stable power supply"}),e("li",{children:"Verify firmware file integrity"}),e("li",{children:"Note current firmware version"}),e("li",{children:"Close unnecessary browser tabs"})]})]}),e("div",{children:[e("h4",{children:"After Update:"}),e("ol",{style:"font-size: 0.875rem; line-height: 1.6;",children:[e("li",{children:"Device will restart automatically"}),e("li",{children:"Wait ~30 seconds for boot"}),e("li",{children:"Reconnect to device IP/hostname"}),e("li",{children:"Verify new firmware version"})]})]})]}),e("div",{style:"margin-top: 1.5rem; padding: 1rem; background-color: var(--light-color); border-radius: 4px; font-size: 0.875rem;",children:[e("h4",{style:"margin-top: 0;",children:"üîß Build Instructions"}),e("p",{style:"margin: 0;",children:"To build firmware for this device:"}),e("div",{style:"background-color: #1e1e1e; color: #ffffff; padding: 0.75rem; border-radius: 4px; margin-top: 0.5rem; font-family: monospace;",children:["# Debug build",e("br",{}),"pio run -e esp32debug",e("br",{}),e("br",{}),"# Release build",e("br",{}),"pio run -e esp32release",e("br",{}),e("br",{}),"# Output: .pio/build/esp32debug/firmware.bin"]})]})]})]})}function X(){const[r,o]=h("/");return e("div",{class:"app",children:[e(H,{currentRoute:r}),e("main",{class:"main-content",children:e(N,{onChange:d=>{o(d.url);const s={"/":"Home","/status":"Status","/config":"Configuration","/debug":"Debug","/log":"Logs","/update":"Firmware Update"};document.title=`ESP32 ET112 Proxy - ${s[d.url]||"Unknown"}`},children:[e(k,{path:"/",component:G}),e(k,{path:"/status",component:j}),e(k,{path:"/config",component:V}),e(k,{path:"/debug",component:Q}),e(k,{path:"/log",component:J}),e(k,{path:"/update",component:K})]})})]})}W(e(X,{}),document.getElementById("app"));
